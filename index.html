<!DOCTYPE html>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<html>
<head>
<title>FRWC Connect</title>
<!-- JQuery for convenience calling remote webserver -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" 
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" 
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Web3 for utilising Metamask -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.6.1-rc.3/web3.min.js" 
        integrity="sha512-0KTZZdA9E3vaLClQkC6S9roiHr9J2A79Q/BvcIwd8LjRVAQcwrT1zorS7hfZ7B3Nr/u6bYzNG/wXOAOADdJ7qQ==" 
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
remote = 'https://api.wizards.quest/'        

requestChallenge = function() {
  let v = document.getElementById('discordID')
  console.log(v.value)
  document.getElementById('output').innerHTML += '<br/>Requesting Challenge from wizards.quest.'
        
  $.ajax({
    url: remote + '?discordID=' + v.value,
  }).done(function(e,v) {
    console.log(e)
    let s = e.split(';')
    let u = s[0]
    console.log(u)
    document.getElementById('input').value = u + '-' + v.value
    document.getElementById('output').innerHTML += '<br/>Received challenge from wizards.quest. Please sign this readable message with your Metamask.'
  }).fail(function(e,v) {
    console.log('Request challenge failed.')
    console.log(e)
    console.log(v)
  })
}
        
signChallenge = function() {
  let v = document.getElementById('input')
  console.log(v.value)
  web3.eth.personal.sign(v.value, accountID[0], 'password', function(e,b) {
    console.log(b)
    let uri = remote + '?challenge=' + v.value + '&response=' + b
    document.getElementById('output').innerHTML += '<br/>Sending signature to wizards.quest: <br/>' + uri
    $.ajax({
      url: uri,
    }).done(function(e,v) {
      console.log('Sign challenge successful, printing response.')
      console.log(e)
      console.log(v)
      document.getElementById('output').innerHTML += '<br/>' + e
    }).fail(function(e,v) {
      console.log('Sign challenge failed.')
      console.log(e)
      console.log(v)
    })
  })
}
            
let accountID = '';
window.addEventListener('load', function () {
  if (window.ethereum) {
    window.web3 = new Web3(ethereum);
    ethereum.enable()
       .then(() => {
       console.log("Ethereum enabled");
       web3.eth.getAccounts(function (err, acc) {
            if (err != null) {
              self.setStatus("There was an error fetching your accounts");
              return;
            }
            if (acc.length > 0) {
              accountID = acc;
              console.log(acc);
            }
       });
       }).catch(() => {
         console.warn('User didn\'t allow access to accounts.');
         waitLogin();
       });
  } else {
    console.log("Non-Ethereum browser detected. You should consider installing MetaMask.");
  }
});
</script>
</head>
<body>
  <input id='discordID' placeholder="Discord ID here"></input><button onclick="requestChallenge()">REQUEST CHALLENGE</button><br/>
  <input id='input' placeholder="Challenge"></input><button onclick="signChallenge()">SIGN</button><br/>
  <div id='output'></div>
</body>
</html>
